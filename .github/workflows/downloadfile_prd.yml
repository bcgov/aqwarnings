name: Download File from Prod S3 Bucket and Commit to Repo

on:
  schedule:
   - cron: '*/10 * * * *'
  workflow_dispatch:  # Allow manual trigger of the workflow remove the push comment to test
  push:
    branches:
      - main

jobs:
  download_file:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code from the repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'  # You can specify the Python version here

    # Step 3: Install the dependencies (e.g., boto3)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3

    # Step 4: Run the Python script to download the file from Dell ECS
    - name: Download file from Dell ECS
      run: |
        python frontend/import_prd.py
      env:
        S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID_PRD }}
        S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY_PRD }}
        S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
        S3_BUCKET: ${{ secrets.S3_BUCKET_PRD }}

    # Step 5: Add, commit, and push the downloaded file to the repository
    - name: Check for downloaded changes
      id: changes
      run: |
        if git status --porcelain | grep .; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "Import new files from BCBOX"
        title: "Automated import from BCBOX"
        body: |
          This PR was automatically created by GitHub Actions.

          New or updated files were downloaded from BCBOX
          during the scheduled workflow run.
        branch: auto/bcbox-import
        base: main
        delete-branch: true