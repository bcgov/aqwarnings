name: Download File from Test S3 Bucket and Commit to Repo

on:
  workflow_dispatch:  # Allow manual trigger of the workflow remove the push comment to test
  push:
    branches:
      - feat/53_auto_postwarnings

jobs:
  download_file:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code from the repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'  # You can specify the Python version here

    # Step 3: Install the dependencies (e.g., boto3)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3

    # Step 4: Run the Python script to download the file from Dell ECS
    - name: Download file from Dell ECS
      run: |
        python frontend/import_tst.py
      env:
        S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID_DEV }}
        S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY_DEV }}
        S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
        S3_BUCKET: ${{ secrets.S3_BUCKET_DEV }}


    - name: Check for downloaded changes
      id: changes
      run: |
        if git status --porcelain | grep .; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "Import new test files from BCBOX"
        title: "Automated test import from BCBOX"
        body: |
          This PR was automatically generated by GitHub Actions.

          New or updated test files were downloaded from BCBOX.
        branch: auto/test-bcbox-import
        base: feat/53_auto_postwarnings
        delete-branch: true 

      # Step 6: Commit and push changes to SAME branch
    - name: Commit and push changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions@users.noreply.github.com"

        git add frontend/warnings_dev
        git commit -m "Auto-sync warnings from BCBOX (DEV)"
        git push origin HEAD

      # Step 7: Generate PR title with current date
    - name: Generate PR title
      if: steps.git-check.outputs.changes == 'true'
      id: pr-title
      run: |
          DATE=$(date +'%Y-%m-%d')
          echo "PR_TITLE=aqwarning-issue- $DATE" >> $GITHUB_ENV

      # Step 8: Create or update PR with dynamic title
    - name: Create or update PR
      if: steps.git-check.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: feat/53_auto_postwarnings
          base: main
          title: ${{ env.PR_TITLE }}
          body: |
            This PR is automatically maintained by GitHub Actions.

            **Changes**
            - Downloaded new/updated warning files from Dell ECS (DEV)
            - Committed directly to `feat/53_auto_postwarnings`

            The PR will be updated automatically on subsequent runs.
          labels: |
            automated
            s3-sync        